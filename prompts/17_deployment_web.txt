è¯·å®ç°PoE2æ™ºèƒ½æ„ç­‘ç”Ÿæˆå™¨Webç‰ˆæœ¬çš„éƒ¨ç½²é…ç½®å’Œä¼˜åŒ–ï¼š

## 17.1 ç”Ÿäº§ç¯å¢ƒé…ç½®

### Dockerå®¹å™¨åŒ– (Dockerfile)
```dockerfile
# å¤šé˜¶æ®µæ„å»º - å‰ç«¯æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS frontend-builder

WORKDIR /frontend
COPY web/package*.json ./
RUN npm ci --only=production

COPY web/ ./
RUN npm run build

# Pythonåº”ç”¨é˜¶æ®µ
FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶Pythonä¾èµ–æ–‡ä»¶
COPY requirements.txt requirements-web.txt ./

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements-web.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY src/ ./src/
COPY poe2_ai_orchestrator.py ./
COPY config/ ./config/

# å¤åˆ¶æ„å»ºå¥½çš„å‰ç«¯æ–‡ä»¶
COPY --from=frontend-builder /frontend/dist ./web/static/

# åˆ›å»ºérootç”¨æˆ·
RUN useradd -m -u 1000 poe2user && \
    chown -R poe2user:poe2user /app
USER poe2user

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8080/api/v1/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["python", "-m", "uvicorn", "src.poe2build.web.app:app", "--host", "0.0.0.0", "--port", "8080", "--workers", "4"]
```

### Webä¾èµ–é…ç½® (requirements-web.txt)
```txt
# FastAPIæ ¸å¿ƒ
fastapi==0.104.1
uvicorn[standard]==0.24.0
python-multipart==0.0.6

# WebSocketæ”¯æŒ
websockets==11.0.3

# é™æ€æ–‡ä»¶å’Œæ¨¡æ¿
aiofiles==23.2.1
jinja2==3.1.2

# CORSå’Œå®‰å…¨
python-cors==1.7.0
python-jose[cryptography]==3.3.0

# ç›‘æ§å’Œæ—¥å¿—
prometheus-fastapi-instrumentator==6.1.0
structlog==23.2.0

# åŸºç¡€ä¾èµ–
-r requirements.txt
```

### ç¯å¢ƒé…ç½® (.env.production)
```env
# WebæœåŠ¡å™¨é…ç½®
HOST=0.0.0.0
PORT=8080
WORKERS=4
DEBUG=false

# CORSé…ç½®
CORS_ORIGINS=["https://poe2builds.example.com"]
CORS_CREDENTIALS=true

# é™æ€æ–‡ä»¶é…ç½®
STATIC_DIR=web/static
STATIC_URL=/static
TEMPLATES_DIR=web/templates

# ç¼“å­˜é…ç½®
REDIS_URL=redis://redis:6379/0
CACHE_TTL=3600

# æ•°æ®åº“é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
DATABASE_URL=postgresql://user:pass@postgres:5432/poe2builds

# ç›‘æ§é…ç½®
SENTRY_DSN=https://your-sentry-dsn
PROMETHEUS_METRICS=true

# SSL/TLSé…ç½®
SSL_CERT_PATH=/etc/ssl/certs/cert.pem
SSL_KEY_PATH=/etc/ssl/private/key.pem

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO
LOG_FORMAT=json
LOG_FILE=/var/log/poe2builds/app.log
```

## 17.2 Docker Composeéƒ¨ç½²

### å®Œæ•´æœåŠ¡æ ˆ (docker-compose.yml)
```yaml
version: '3.8'

services:
  # ä¸»åº”ç”¨æœåŠ¡
  poe2-web:
    build: .
    ports:
      - "8080:8080"
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/poe2builds
    depends_on:
      - redis
      - postgres
    volumes:
      - ./logs:/var/log/poe2builds
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - poe2-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - poe2-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  # PostgreSQLæ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=poe2builds
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - poe2-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/ssl/certs:ro
      - ./web/static:/var/www/static:ro
    depends_on:
      - poe2-web
    restart: unless-stopped
    networks:
      - poe2-network

  # ç›‘æ§æœåŠ¡
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - poe2-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana:/etc/grafana/provisioning:ro
    networks:
      - poe2-network
    restart: unless-stopped

volumes:
  redis_data:
  postgres_data:
  prometheus_data:
  grafana_data:

networks:
  poe2-network:
    driver: bridge
```

### Nginxåå‘ä»£ç†é…ç½® (nginx.conf)
```nginx
events {
    worker_connections 1024;
}

http {
    upstream poe2_backend {
        server poe2-web:8080;
    }

    # å¯ç”¨gzipå‹ç¼©
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        root /var/www/static;
        try_files $uri @backend;
    }

    # APIè¯·æ±‚ä»£ç†
    location /api/ {
        proxy_pass http://poe2_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketæ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocketä»£ç†
    location /ws/ {
        proxy_pass http://poe2_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ä¸»é¡µé¢å’Œé™æ€å†…å®¹
    location / {
        try_files $uri @backend;
    }

    location @backend {
        proxy_pass http://poe2_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SSLé…ç½®
    listen 443 ssl http2;
    ssl_certificate /etc/ssl/certs/cert.pem;
    ssl_certificate_key /etc/ssl/certs/key.pem;
    
    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
}
```

## 17.3 Kuberneteséƒ¨ç½²

### åº”ç”¨éƒ¨ç½²é…ç½® (k8s/deployment.yaml)
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: poe2-web
  labels:
    app: poe2-web
spec:
  replicas: 3
  selector:
    matchLabels:
      app: poe2-web
  template:
    metadata:
      labels:
        app: poe2-web
    spec:
      containers:
      - name: poe2-web
        image: poe2build/web:latest
        ports:
        - containerPort: 8080
        env:
        - name: REDIS_URL
          value: "redis://redis-service:6379/0"
        - name: LOG_LEVEL
          value: "INFO"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /api/v1/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/v1/health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        volumeMounts:
        - name: data-volume
          mountPath: /app/data
        - name: logs-volume
          mountPath: /var/log/poe2builds
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: poe2-data-pvc
      - name: logs-volume
        persistentVolumeClaim:
          claimName: poe2-logs-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: poe2-web-service
spec:
  selector:
    app: poe2-web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: LoadBalancer

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: poe2-web-ingress
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - poe2builds.example.com
    secretName: poe2-tls
  rules:
  - host: poe2builds.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: poe2-web-service
            port:
              number: 80
```

## 17.4 ç›‘æ§å’Œæ—¥å¿—

### Prometheusç›‘æ§é…ç½® (monitoring/prometheus.yml)
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'poe2-web'
    static_configs:
      - targets: ['poe2-web:8080']
    metrics_path: /metrics
    scrape_interval: 10s

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']
```

### å‘Šè­¦è§„åˆ™ (monitoring/alert_rules.yml)
```yaml
groups:
- name: poe2-web-alerts
  rules:
  - alert: PoE2WebDown
    expr: up{job="poe2-web"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "PoE2 Web service is down"
      description: "PoE2 Web service has been down for more than 1 minute"

  - alert: HighResponseTime
    expr: http_request_duration_seconds{quantile="0.95"} > 5
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High response time detected"
      description: "95th percentile response time is {{ $value }}s"

  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value }} errors per second"

  - alert: HighMemoryUsage
    expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage"
      description: "Memory usage is {{ $value | humanizePercentage }}"
```

### æ—¥å¿—é…ç½® (src/poe2build/web/logging_config.py)
```python
import structlog
import logging
import sys
from pythonjsonlogger import jsonlogger
from pathlib import Path

def configure_logging(log_level: str = "INFO", log_format: str = "json"):
    """é…ç½®ç»“æ„åŒ–æ—¥å¿—"""
    
    # é…ç½®ç»“æ„åŒ–æ—¥å¿—
    structlog.configure(
        processors=[
            structlog.stdlib.filter_by_level,
            structlog.stdlib.add_logger_name,
            structlog.stdlib.add_log_level,
            structlog.stdlib.PositionalArgumentsFormatter(),
            structlog.processors.TimeStamper(fmt="iso"),
            structlog.processors.StackInfoRenderer(),
            structlog.processors.format_exc_info,
            structlog.processors.UnicodeDecoder(),
            structlog.processors.JSONRenderer() if log_format == "json" else structlog.dev.ConsoleRenderer()
        ],
        context_class=dict,
        logger_factory=structlog.stdlib.LoggerFactory(),
        wrapper_class=structlog.stdlib.BoundLogger,
        cache_logger_on_first_use=True,
    )
    
    # é…ç½®æ ‡å‡†æ—¥å¿—
    logging.basicConfig(
        level=getattr(logging, log_level.upper()),
        format='%(message)s',
        stream=sys.stdout
    )
    
    # é…ç½®æ–‡ä»¶æ—¥å¿—
    log_file = Path("/var/log/poe2builds/app.log")
    log_file.parent.mkdir(parents=True, exist_ok=True)
    
    file_handler = logging.FileHandler(log_file)
    if log_format == "json":
        formatter = jsonlogger.JsonFormatter(
            '%(asctime)s %(name)s %(levelname)s %(message)s'
        )
        file_handler.setFormatter(formatter)
    
    root_logger = logging.getLogger()
    root_logger.addHandler(file_handler)
    
    return structlog.get_logger()
```

## 17.5 æ€§èƒ½ä¼˜åŒ–

### åº”ç”¨æ€§èƒ½ä¼˜åŒ–
1. **å¼‚æ­¥å¤„ç†ä¼˜åŒ–**
```python
# è¿æ¥æ± é…ç½®
import aioredis
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.pool import QueuePool

# Redisè¿æ¥æ± 
redis_pool = aioredis.ConnectionPool.from_url(
    "redis://redis:6379/0",
    max_connections=20
)

# æ•°æ®åº“è¿æ¥æ± 
engine = create_async_engine(
    "postgresql+asyncpg://user:pass@postgres:5432/poe2builds",
    pool_size=20,
    max_overflow=0,
    poolclass=QueuePool,
    pool_recycle=3600
)
```

2. **ç¼“å­˜ç­–ç•¥**
```python
# å¤šå±‚ç¼“å­˜é…ç½®
CACHE_CONFIG = {
    "build_results": {
        "ttl": 1800,  # 30åˆ†é’Ÿ
        "max_size": 1000
    },
    "system_status": {
        "ttl": 60,   # 1åˆ†é’Ÿ
        "max_size": 100
    },
    "static_data": {
        "ttl": 3600,  # 1å°æ—¶
        "max_size": 500
    }
}
```

### å‰ç«¯æ€§èƒ½ä¼˜åŒ–
1. **èµ„æºä¼˜åŒ–**
```javascript
// æ‡’åŠ è½½é…ç½®
const lazyLoadConfig = {
    root: null,
    rootMargin: '50px',
    threshold: 0.1
};

// ä»£ç åˆ†å‰²
const BuildGenerator = () => import('./components/BuildGenerator.js');
const BuildResults = () => import('./components/BuildResults.js');
```

2. **Service Workerç¼“å­˜**
```javascript
// service-worker.js
const CACHE_NAME = 'poe2-builds-v1';
const urlsToCache = [
    '/',
    '/static/css/poe2-theme.css',
    '/static/js/app.js',
    '/static/assets/poe2-logo.png'
];

self.addEventListener('install', event => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(cache => cache.addAll(urlsToCache))
    );
});
```

## 17.6 å®‰å…¨é…ç½®

### Webåº”ç”¨å®‰å…¨
1. **ä¸­é—´ä»¶å®‰å…¨é…ç½®**
```python
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware

app.add_middleware(
    TrustedHostMiddleware, 
    allowed_hosts=["poe2builds.example.com", "*.poe2builds.example.com"]
)
app.add_middleware(HTTPSRedirectMiddleware)
```

2. **APIå®‰å…¨**
```python
# é€Ÿç‡é™åˆ¶
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

@app.post("/api/v1/build/generate")
@limiter.limit("10/minute")
async def generate_build(request: Request, build_request: BuildRequest):
    pass
```

## 17.7 éƒ¨ç½²è„šæœ¬

### ä¸€é”®éƒ¨ç½²è„šæœ¬ (scripts/deploy.sh)
```bash
#!/bin/bash
set -e

# é…ç½®å˜é‡
APP_NAME="poe2-web"
DOCKER_REGISTRY="your-registry.com"
VERSION=${1:-latest}

echo "å¼€å§‹éƒ¨ç½² PoE2 Build Generator Web ç‰ˆæœ¬ $VERSION"

# æ„å»ºé•œåƒ
echo "æ„å»ºDockeré•œåƒ..."
docker build -t $DOCKER_REGISTRY/$APP_NAME:$VERSION .
docker build -t $DOCKER_REGISTRY/$APP_NAME:latest .

# æ¨é€é•œåƒ
echo "æ¨é€é•œåƒåˆ°æ³¨å†Œè¡¨..."
docker push $DOCKER_REGISTRY/$APP_NAME:$VERSION
docker push $DOCKER_REGISTRY/$APP_NAME:latest

# éƒ¨ç½²åˆ°Kubernetes
if [ "$2" == "k8s" ]; then
    echo "éƒ¨ç½²åˆ°Kubernetes..."
    kubectl apply -f k8s/
    kubectl rollout restart deployment/$APP_NAME
    kubectl rollout status deployment/$APP_NAME
else
    # Docker Composeéƒ¨ç½²
    echo "ä½¿ç”¨Docker Composeéƒ¨ç½²..."
    docker-compose down
    docker-compose pull
    docker-compose up -d
fi

# å¥åº·æ£€æŸ¥
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

if curl -f http://localhost:8080/api/v1/health; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œ"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼æœåŠ¡å¥åº·æ£€æŸ¥æœªé€šè¿‡"
    exit 1
fi

echo "ğŸ‰ PoE2 Build Generator Web éƒ¨ç½²å®Œæˆï¼"
echo "è®¿é—®åœ°å€: https://poe2builds.example.com"
```

### CI/CD Pipeline (.github/workflows/deploy.yml)
```yaml
name: Deploy to Production

on:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Run tests
      run: |
        pip install -r requirements-web.txt
        pytest tests/ -v

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_REGISTRY }}/poe2-web:latest
          ${{ secrets.DOCKER_REGISTRY }}/poe2-web:${{ github.sha }}
    
    - name: Deploy to Kubernetes
      uses: azure/k8s-deploy@v1
      with:
        manifests: |
          k8s/deployment.yaml
        images: |
          ${{ secrets.DOCKER_REGISTRY }}/poe2-web:${{ github.sha }}
```

è¯·ç¡®ä¿Webéƒ¨ç½²é…ç½®ï¼š
1. å®Œæ•´çš„å®¹å™¨åŒ–å’Œç¼–æ’é…ç½®
2. ç”Ÿäº§çº§çš„æ€§èƒ½ä¼˜åŒ–
3. å…¨é¢çš„ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ
4. å¼ºåŒ–çš„å®‰å…¨é…ç½®
5. è‡ªåŠ¨åŒ–çš„CI/CDæµç¨‹
6. å¤šç¯å¢ƒæ”¯æŒï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
7. ç¾éš¾æ¢å¤å’Œå¤‡ä»½ç­–ç•¥
8. è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨é…ç½®

å®ç°æ—¶è¯·ç¡®ä¿éƒ¨ç½²æ–¹æ¡ˆæ”¯æŒæ°´å¹³æ‰©å±•ã€æ•…éšœæ¢å¤å’Œé›¶å®•æœºæ›´æ–°ï¼Œä¸ºPoE2ç©å®¶æä¾›ç¨³å®šå¯é çš„WebæœåŠ¡ä½“éªŒã€‚